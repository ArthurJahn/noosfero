#!/usr/bin/ruby
require File.dirname(__FILE__) + '/../config/environment'

include ActionController::UrlWriter

IMPORT_DIR = ENV['IMPORT_DIR'] || '/home/terceiro/src/cooperation-migration/data/export'

if ARGV.size == 0
  puts "usage: %s <username> [ <username> [ <username> ... ] ]" % $PROGRAM_NAME
  exit(1)
end

def import_environment(domain_name)
  env = Environment.default
  env.domains << get_domain(domain_name)
  return Environment.default
end

def get_domain(envname)
  suffix = (ENV['RAILS_ENV'] == 'production') ? '' : '.local'
  domain = Domain.find_or_create_by_name(envname + suffix)
end

TinyMceArticle # forces loading the Noosfero class before adding stuff to it
class TinyMceArticle
  attr_accessor :is_homepage
end
UploadedFile # force loading Noosfero class before addinf stuff to it
class UploadedFile
  attr_accessor :is_homepage, :filesystem_location
end

Person # forces loading Noosfero class before adding stuff to id
class Person
  delegate :crypted_password=, :to => :user
  delegate :salt=, :to => :user
  delegate :password_type=, :to => :user
end

class FileData < StringIO
  attr_reader :original_filename, :content_type
  def initialize(actual_filename, name, content_type)
    @original_filename = name
    @content_type = content_type
    super(File.read(actual_filename))
  end
end

class Progress
  def self.instance
    @instance ||= self.new
  end
  def start(n)
    @total = n
    @current = 0
  end
  def step
    @current += 1
  end
  def puts(msg)
    Kernel.puts("[%d/%d] %s" %  [@current, @total, msg])
  end
end

Progress.instance.start(ARGV.size)
for username in ARGV
  Progress.instance.step
  begin
    User.transaction do
      # guess environment
      domain_name = username.gsub(/^.*@/, '')
      environment = import_environment(domain_name)

      # create user
      login = username.gsub(/@.*$/, '')
      user = User.new(:login => login, :email => username, :environment => environment)

      # import person data
      person = Person.new(:identifier => login)
      user.person = person
      person.user = user
      person.from_xml(File.read(File.join(IMPORT_DIR, username + '.xml')))
      person.preferred_domain = get_domain(domain_name)
      user.save!
      Progress.instance.puts "I: #{username} data imported"

      # import articles
      Dir.glob(File.join(IMPORT_DIR, username, 'articles', '*.xml')) do |xml|
        Progress.instance.puts "I: Trying to import #{username}'s article in #{xml} ..."
        article = TinyMceArticle.new
        article.from_xml(File.read(xml))
        article.profile = person
        if article.valid?
          article.save!
          Progress.instance.puts "I: #{username}'s article #{article.name.inspect} imported"
        else
          $stderr.puts "W: #{username}'s article #{article.name.inspect} cannot be saved. Errors: #{article.errors.full_messages.join(', ')}"
          next
        end

        if article.is_homepage
          person.home_page = article
          person.save!
          Progress.instance.puts "I: Article #{article.name.inspect} is #{username}'s homepage!"
        end

        File.open("tmp/rewrite.txt", 'w+') do |file|
          file.puts("#{article.id} #{url_for(article.url)}")
          Progress.instance.puts "I: Article with id = #{article.id} redirected to #{url_for(article.url)}"
        end

        # import attachments
        attachments_dir = xml.gsub(/\.xml$/, '')
        Dir.glob(File.join(attachments_dir, 'attachments', '*.xml')).each do |attachment_xml|
          file = UploadedFile.new
          file.from_xml(File.read(attachment_xml))
          if !File.exist?(file.filesystem_location)
            Progress.instance.puts "W: skipping attachment pointing to unexisting file"
            next
          end
          Progress.instance.puts "I: about to read data from #{file.filesystem_location} (xml: #{attachment_xml})"
          file.uploaded_data = FileData.new(file.filesystem_location, file.filename, file.content_type)
          file.parent = article
          file.profile = person
          Progress.instance.puts "I: Trying to save attachment \"#{file.filename}/#{file.slug}\""
          file.save!
          Progress.instance.puts "I: attachment added to article #{article.id}"

          file.reload
          if file.image?
            file.parent.body ||= ''
            file.parent.body = "<img align='left' style='margin-right: 5px; margin-bottom: 5px;' src='/#{login}/#{file.path}'/> " + file.parent.body
          else
            if file.parent.body
              file.parent.body += "<hr/><div><a href='/#{login}/#{file.path}'>#{file.abstract}</a></div>"
            end
          end
          file.parent.save

        end
      end

      # import menus
      for i in [1,2]
        links = []
        data = Hash.from_xml(File.read(File.join(IMPORT_DIR, username, "menu#{i}.xml")))
        data['menu']['items'].each do |item|
          links << { :name => item['title'], :address => item['url'] }
        end
        block = person.blocks.select { |block| block.class == LinkListBlock }[i-1]
        block.title = data['menu']['title']
        block.links = links
        block.save!
        Progress.instance.puts "imported links: #{links.inspect}"
      end

    end
  rescue Exception => e
    $stderr.puts "=================================="
    $stderr.puts "E: importing <#{username}> failed."
    $stderr.puts e
    $stderr.puts e.backtrace
    $stderr.puts "=================================="
    $stderr.puts "E: Note that ALL operations above relative to <#{username}> were CANCELLED due to these errors."
  end
end
